# This file is autogenerated

# Template input parameters:
# 'tier':

service: {{ lambda.service_name }}-lambda  # drift-base-lambda


plugins:
  - serverless-wsgi
  - serverless-python-requirements
custom:
  wsgi:
    app: {{ lambda.wsgiapp }} # drift.serverless.app
    packRequirements: false

  pythonRequirements:
    usePipenv: true
    dockerizePip: true
    dockerFile: Dockerfile


provider:
  name: aws
  runtime: python3.6
  stage: main
  stackName: {{ tier.tier_name }}-{{ lambda.service_name }}-lambda
  region: {{ tier.aws_region }}
  timeout: 30  # The default is 6 seconds. Note: API Gateway current maximum is 30 seconds
  deploymentBucket:
    name: serverless-devnorth # TEMPLATIZED
  vpc:
    securityGroupIds: [{% for sg in tier.security_groups %}{{ sg }}{{ ", " if not loop.last }}{% endfor %}]
    subnetIds: [{% for subnet in tier.subnets %}{{ subnet }}{{ ", " if not loop.last }}{% endfor %}]
  environment: # Service wide environment variables
    DRIFT_TIER: {{ tier.tier_name }}                                                        # TEMPLATIZED
    DRIFT_CONFIG_URL: {{ tier.config_url }}

  tags:
      tier: DEVNORTH
      service-name: {{ lambda.service_name }}
      service-type: {{ lambda.service_type }}
      Name: {{ tier.tier_name }}-{{ lambda.service_name }}

  # API Gateway
  apiName: {{ tier.tier_name }}-{{ lambda.service_name }}
  endpointType: private

  resourcePolicy:
    - Effect: Deny
      Principal: "*"
      Action: execute-api:Invoke
      Resource:
        - execute-api:/*/*/*
      Condition:
        StringNotEquals:
          "aws:sourceVpc": {{ lambda.vpc_id }}
    - Effect: Allow
      Principal: "*"
      Action: execute-api:Invoke
      Resource:
        - execute-api:/*/*/*

functions:
  app:
    handler: wsgi.handler
    events:
      - http: ANY /
      - http: 'ANY {proxy+}'
